---
slug: llm-finetuning-automation-prefect-mlflow
title: LLM íŒŒì¸íŠœë‹ ì›Œí¬í”Œë¡œìš° êµ¬ì¶• (Prefect + MLflow)
authors: [me]
tags: [ai, mlops]
date: 2026-01-18
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

> **ìš”ì•½:** ë¶„ì„ê°€ë“¤ì´ ê°œë³„ ë¡œì»¬ Python ì½”ë“œë¡œ ìˆ˜í–‰í•˜ë˜ LLM íŒŒì¸íŠœë‹ ì‘ì—…ì„ **Prefect**ë¡œ ì›Œí¬í”Œë¡œìš°í™”í•˜ì—¬ ìë™í™”í•˜ê³ , **MLflow**ë¡œ ì‹¤í—˜ ì´ë ¥ì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì—¬ íŒ€ì˜ ìƒì‚°ì„±ì„ ê·¹ëŒ€í™”í•˜ëŠ” ì „ëµì„ ì œì•ˆí•©ë‹ˆë‹¤.

---

## 1. ë“¤ì–´ê°€ë©°: ì™œ ì§€ê¸ˆ ì›Œí¬í”Œë¡œìš° ë„êµ¬ì¸ê°€?

### ğŸ˜¢ ìš°ë¦¬ì˜ ìŠ¬í”ˆ í˜„ì‹¤ (Before)
ê°€ìƒì˜ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ í•˜ë‚˜ ìƒê°í•´ ë´…ì‹œë‹¤. ì—¬ëŸ¬ë¶„ì€ ì‚¬ë‚´ FAQ ì±—ë´‡ì„ ë§Œë“¤ê¸° ìœ„í•´ **Llama-3 ëª¨ë¸ì„ íŒŒì¸íŠœë‹**í•˜ëŠ” ì„ë¬´ë¥¼ ë§¡ì•˜ìŠµë‹ˆë‹¤.

* "ì§€ë‚œì£¼ì— ì„±ëŠ¥ ì œì¼ ì¢‹ì•˜ë˜ ëª¨ë¸, ëŸ¬ë‹ ë ˆì´íŠ¸(Learning Rate)ë¥¼ 2e-5ë¡œ ì¤¬ë˜ê°€? 3e-5ì˜€ë‚˜?" (ì´ë ¥ ì‹¤ì¢…)
* "ìƒˆë²½ì— 10ì‹œê°„ì§œë¦¬ í•™ìŠµ ëŒë ¤ë†“ê³  ì¤ëŠ”ë°, ë©”ëª¨ë¦¬ ì—ëŸ¬ë¡œ 1ì‹œê°„ ë§Œì— ë©ˆì¶°ë²„ë ¸ë„¤..." (ëª¨ë‹ˆí„°ë§ ë° ì¬ì‹¤í–‰ ë¶€ì¬)
* "ê¹€ ì—°êµ¬ì›ë‹˜ ì½”ë“œëŠ” ì œ ì»´í“¨í„°ì—ì„œ ì•ˆ ëŒì•„ê°€ìš”." (ì¬í˜„ì„± ë¶€ì¡±)

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **ì›Œí¬í”Œë¡œìš° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜(Prefect)**ê³¼ **ì‹¤í—˜ ì¶”ì (MLflow)**ì˜ ë„ì…ì€ ì„ íƒì´ ì•„ë‹Œ í•„ìˆ˜ì…ë‹ˆë‹¤.

---

## 2. Prefectì™€ MLflowë€?

* **Prefect**: í˜„ëŒ€ì ì¸ ì›Œí¬í”Œë¡œìš° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ì…ë‹ˆë‹¤. "ëˆ„ê°€, ì–¸ì œ, ì–´ë–»ê²Œ" ì½”ë“œë¥¼ ì‹¤í–‰í–ˆëŠ”ì§€ ê´€ë¦¬í•˜ë©°, ì‹¤íŒ¨ ì‹œ **ìë™ ì¬ì‹œë„(Retry)** ê¸°ëŠ¥ì´ í•µì‹¬ì…ë‹ˆë‹¤.
* **MLflow**: ë¨¸ì‹ ëŸ¬ë‹ ì‹¤í—˜ ì¶”ì  ë„êµ¬ì…ë‹ˆë‹¤. "ë¬´ì—‡ì„ ì‹¤í—˜í–ˆê³ , ì–´ë–¤ ê²°ê³¼(Loss, Accuracy)ê°€ ë‚˜ì™”ëŠ”ì§€" ì˜êµ¬íˆ ê¸°ì–µí•©ë‹ˆë‹¤.

ì´ ë‘˜ì„ í•©ì¹˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì´ìƒì ì¸ ì•„í‚¤í…ì²˜ê°€ ì™„ì„±ë©ë‹ˆë‹¤.

![Architecture Diagram](./img/architecture-generic.png)

1. **Data Source**: í´ë¼ìš°ë“œ ì €ì¥ì†Œ(S3, Azure Blob Storage)ë‚˜ ë¡œì»¬ í´ë”ì— í•™ìŠµ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ë©´
2. **Prefect Flow**: ìë™ìœ¼ë¡œ íŒŒì´í”„ë¼ì¸ì´ ì‹œì‘ë˜ì–´ GPU í™˜ê²½(ë¡œì»¬/í´ë¼ìš°ë“œ)ì— í•™ìŠµì„ ì§€ì‹œí•˜ê³ 
3. **MLflow & Registry**: í•™ìŠµ ì¤‘ ë°œìƒí•˜ëŠ” ëª¨ë“  ë¡œê·¸ì™€ ê²°ê³¼ ëª¨ë¸ì„ ì €ì¥ì†Œì— ê¸°ë¡í•©ë‹ˆë‹¤.

---

## 3. Prefect í•µì‹¬ ë°ì½”ë ˆì´í„° (Concepts)

Prefectë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì•Œì•„ì•¼ í•  ê²ƒì€ ë”± ë‘ ê°€ì§€, **`@flow`**ì™€ **`@task`** ë°ì½”ë ˆì´í„°ë¿ì…ë‹ˆë‹¤.

### ğŸ”¹ 1. @flow (íë¦„)
ì›Œí¬í”Œë¡œìš°ì˜ **ì§„ì…ì (Entrypoint)**ì´ì ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤.
íŒŒì´ì¬ í•¨ìˆ˜ ìœ„ì— `@flow`ë§Œ ë¶™ì´ë©´, í•´ë‹¹ í•¨ìˆ˜ëŠ” ìƒíƒœ(State) ëª¨ë‹ˆí„°ë§ì´ ê°€ëŠ¥í•œ ì›Œí¬í”Œë¡œìš°ë¡œ ë³€ì‹ í•©ë‹ˆë‹¤.
- **ì—­í• **: ì „ì²´ ë¡œì§ì˜ ìˆœì„œë¥¼ ì •ì˜í•˜ê³ , í•˜ìœ„ Taskë“¤ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
- **ì£¼ìš” ì˜µì…˜**:
    - `name`: ëŒ€ì‹œë³´ë“œì— í‘œì‹œë  íŒŒì´í”„ë¼ì¸ ì´ë¦„ ì •ì˜
    - `log_prints=True`: `print()` í•¨ìˆ˜ ì¶œë ¥ì„ ìë™ìœ¼ë¡œ ë¡œê·¸ë¡œ ìˆ˜ì§‘
    - `retries`: íë¦„ ìì²´ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ ì¬ì‹œë„ íšŸìˆ˜

### ğŸ”¹ 2. @task (ì‘ì—…)
ì›Œí¬í”Œë¡œìš° ì•ˆì—ì„œ ì‹¤í–‰ë˜ëŠ” **ìµœì†Œ ì‘ì—… ë‹¨ìœ„**ì…ë‹ˆë‹¤.
ë³µì¡í•œ ë¡œì§ì„ ì˜ê²Œ ìª¼ê°œì–´ Taskë¡œ ë§Œë“¤ë©´, íŠ¹ì • ë¶€ë¶„ë§Œ ì‹¤íŒ¨í–ˆì„ ë•Œ ê·¸ ë¶€ë¶„ë§Œ ì¬ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ì—­í• **: ì‹¤ì œ ì—°ì‚°, ë°ì´í„° ë¡œë“œ, í•™ìŠµ ë“±ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- **ì£¼ìš” ì˜µì…˜**:
    - `retries`: ì‘ì—… ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íšŸìˆ˜ (ì˜ˆ: GPU Out of Memory, ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ìœ ìš©)
    - `retry_delay_seconds`: ì¬ì‹œë„ ì „ ëŒ€ê¸° ì‹œê°„
    - `cache_expiration`: ê²°ê³¼ ìºì‹± ë§Œë£Œ ì‹œê°„ (ì˜ˆ: "ë°ì´í„° ë¡œë“œëŠ” í•˜ë£¨ì— í•œ ë²ˆë§Œ í•´")

> **[ì°¸ê³ ]** ë” ìì„¸í•œ ì˜µì…˜ì€ [Prefect ê³µì‹ ë¬¸ì„œ(Concepts)](https://docs.prefect.io/v3/concepts)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

---

## 4. ì‹¤ì „ ê°€ì´ë“œ: í™˜ê²½ ì„¤ì •ë¶€í„° ì½”ë“œê¹Œì§€

### 4.1 í™˜ê²½ ì„¤ì • (Setup)

ë¨¼ì € í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•˜ê³  ì„œë²„ë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

<Tabs>
  <TabItem value="install" label="1. ì„¤ì¹˜(Install)" default>

```bash
# Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
pip install prefect mlflow
```

</TabItem>
  <TabItem value="server" label="2. ì„œë²„ ì‹¤í–‰(Server)">

```bash
# Prefect ì„œë²„ ì‹œì‘ (ë¡œì»¬ ëŒ€ì‹œë³´ë“œ)
prefect server start

# MLflow ì„œë²„ ì‹œì‘ (ë³„ë„ í„°ë¯¸ë„)
mlflow ui
```

</TabItem>
</Tabs>

### 4.2 íŒŒì´ì¬ ì½”ë“œ êµ¬í˜„

ê¸°ì¡´ íŒŒì´ì¬ í•™ìŠµ ì½”ë“œì— `@task`ì™€ `@flow` ë°ì½”ë ˆì´í„°ë§Œ ë¶™ì´ë©´ ë©ë‹ˆë‹¤.

```python title="finetune_flow.py"
import mlflow
import time
import random
from prefect import flow, task
from datetime import timedelta

# [Tip] ìºì‹±ì„ ì ìš©í•˜ì—¬ ë°ì´í„° ë¡œë“œê°€ ì‹¤íŒ¨í•´ë„ ì¬ì‹œë„í•˜ê±°ë‚˜, ì´ë¯¸ ë¡œë“œí–ˆë‹¤ë©´ ê±´ë„ˆëœë‹ˆë‹¤.
@task(cache_expiration=timedelta(days=1))
def load_dataset(data_path: str):
    print(f"ë°ì´í„°ì…‹ ë¡œë“œ ì¤‘: {data_path}")
    time.sleep(1) # ë¡œë”© ì‹œë®¬ë ˆì´ì…˜
    return {"data_id": "corpus_v1", "size": 10000}

# [í•µì‹¬] GPU ì˜¤ë¥˜ ë“±ìœ¼ë¡œ ì‹¤íŒ¨ ì‹œ 60ì´ˆ ë’¤ ìµœëŒ€ 3íšŒ ì¬ì‹œë„í•˜ë„ë¡ ì„¤ì •
@task(retries=3, retry_delay_seconds=60) 
def train_model(dataset, params):
    print("ëª¨ë¸ íŒŒì¸íŠœë‹ ì‹œì‘...")
    
    # MLflow ì‹¤í—˜ ì´ë¦„ ì„¤ì •
    mlflow.set_experiment("Llama3-Finetuning-Experiment")
    
    with mlflow.start_run():
        # í•˜ì´í¼íŒŒë¼ë¯¸í„° ê¸°ë¡
        mlflow.log_params(params)
        
        loss = 2.5
        for epoch in range(params["epochs"]):
            # (ê°€ìƒì˜ í•™ìŠµ ë¡œì§)
            loss = loss * 0.85 + random.uniform(0, 0.05) 
            print(f"Epoch {epoch+1}/{params['epochs']}: Loss {loss:.4f}")
            
            # [í•µì‹¬] ì§€í‘œ ì‹¤ì‹œê°„ ê¸°ë¡ -> MLflow ê·¸ë˜í”„ë¡œ ê·¸ë ¤ì§
            mlflow.log_metric("train_loss", loss, step=epoch)
        
        # ëª¨ë¸ ì €ì¥
        print(f"í•™ìŠµ ì™„ë£Œ. Final Loss: {loss:.4f}")
        
    return loss

# ì „ì²´ íë¦„ ì •ì˜
@flow(name="Llama-3 Finetuning Pipeline")
def finetuning_workflow(epochs: int = 5):
    data = load_dataset("./data/faq_corpus.json")
    
    params = {
        "epochs": epochs,
        "learning_rate": 2e-5,
        "model": "meta-llama/Meta-Llama-3-8B"
    }
    
    final_loss = train_model(data, params)
    
    if final_loss < 0.5:
        print("ëª¨ë¸ ì„±ëŠ¥ ìš°ìˆ˜! ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘")

if __name__ == "__main__":
    finetuning_workflow(epochs=10)
```

:::tip MLflow ì‹¤í—˜ ì´ë¦„ ê´€ë¦¬
`mlflow.set_experiment()`ë¡œ í”„ë¡œì íŠ¸ë³„ë¡œ ì‹¤í—˜ ì´ë¦„ì„ êµ¬ë¶„í•´ ì£¼ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ì‹¤í—˜ì´ `Default`ì— ìŒ“ì—¬ ë‚˜ì¤‘ì— ì°¾ê¸° í˜ë“¤ì–´ì§‘ë‹ˆë‹¤.
:::

---

## 5. ê²°ê³¼ í™•ì¸: ì´ë ‡ê²Œ ë°”ë€ë‹ˆë‹¤

### Prefect ëŒ€ì‹œë³´ë“œ (ì•ˆì •ì„± í™•ë³´)
ìƒˆë²½ì— í•™ìŠµì´ ì‹¤íŒ¨í–ˆë‚˜ìš”? Prefect ëŒ€ì‹œë³´ë“œ ë‚´ ì‹¤íŒ¨í•œ Flow Run ìƒì„¸ í˜ì´ì§€ ìš°ì¸¡ ìƒë‹¨ì— ìˆëŠ” **ì¬ì‹œë„(Retry)** ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¬ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> **ğŸ’¡ ì™œ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì•ˆ í•´ë„ ë ê¹Œìš”?** <br/>
> ì•ì„œ ì½”ë“œì— ì„¤ì •í•œ ìºì‹±(`cache_expiration`) ë•ë¶„ì…ë‹ˆë‹¤!
> PrefectëŠ” ì„±ê³µí•œ Taskì˜ ê²°ê³¼(Result)ë¥¼ ì €ì¥í•´ ë‘ê¸° ë•Œë¬¸ì—, ì¬ì‹¤í–‰ ì‹œ **ì´ë¯¸ ì„±ê³µí•œ 'ë°ì´í„° ë¡œë“œ' ë‹¨ê³„ëŠ” ê±´ë„ˆë›°ê³  ì‹¤íŒ¨í•œ 'í•™ìŠµ' ë‹¨ê³„ë¶€í„° ì¦‰ì‹œ ì¬ê°œ**ë©ë‹ˆë‹¤. ì´ê²ƒì´ ë°”ë¡œ Prefectê°€ ìë‘í•˜ëŠ” **[Result Persistence(ê²°ê³¼ ì˜ì†ì„±)](https://docs.prefect.io/v3/concepts/results)**ì™€ **[Caching(ìºì‹±)](https://docs.prefect.io/v3/concepts/tasks/#caching)** ë©”ì»¤ë‹ˆì¦˜ì…ë‹ˆë‹¤.

![Prefect Dashboard](./img/prefect-dashboard.png)

### MLflow íŠ¸ë˜í‚¹ (ì¸ì‚¬ì´íŠ¸ í™•ë³´)
ëŸ¬ë‹ ë ˆì´íŠ¸ë¥¼ ë°”ê¿¨ì„ ë•Œ Lossê°€ ì–´ë–»ê²Œ ë³€í–ˆëŠ”ì§€, ê·¸ë˜í”„ë¡œ í•œëˆˆì— ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![MLflow Chart](./img/mlflow-chart.png)

---

## 6. ë§ºìŒë§

Prefectì™€ MLflowì˜ ì¡°í•©ì€ **"ë¶„ì„ê°€ì˜ ììœ ë¥¼ í•´ì¹˜ì§€ ì•Šìœ¼ë©´ì„œ ì—”ì§€ë‹ˆì–´ë§ì˜ ê·œìœ¨ì„ ë„ì…"**í•˜ëŠ” ê°€ì¥ í˜„ëª…í•œ ë°©ë²•ì…ë‹ˆë‹¤.

ì§€ê¸ˆ ë°”ë¡œ ê¸°ì¡´ ì½”ë“œì— `@flow` ë°ì½”ë ˆì´í„°ë¥¼ ë¶™ì—¬ë³´ì„¸ìš”. ë‹¨ìˆœ ë°˜ë³µ ì‘ì—…ì´ì—ˆë˜ íŒŒì¸íŠœë‹ ì—…ë¬´ê°€ ìš°ë¦¬ íŒ€ì˜ ì†Œì¤‘í•œ **ìì‚°**ìœ¼ë¡œ ë°”ë€ŒëŠ” ì‹œì‘ì ì´ ë  ê²ƒì…ë‹ˆë‹¤.
